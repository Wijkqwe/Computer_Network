
\chapter{数据链路层}

\section{功能}

使用物理层提供的\textbf{比特传输}服务；

为网络层提供服务，将网络层的\textbf{IP数据报（分组）}封装称帧，发送给下一结点；


\paragraph{物理链路}
传输介质（0层）+ 物理层（1层）实现相邻结点之间物理链路

\paragraph{逻辑链路}
数据链路层基于物理链路，实现相邻结点之间逻辑上无差错的“数据链路（逻辑链路）”


\subsection{封装成帧（组帧）}

\subsubsection{帧定界}
如何让接收方确定帧的界限


\subsubsection{透明传输}
接收方能够去除帧定界的附加信息


\subsubsection{字符计数法}
每个帧的开头用一个\textbf{定长计数字段}表示帧长。

帧长 = 定长计数字段长度 + 数据部分长度

缺点：任一计数字段出错，会导致后续所有帧无法定界。


\subsubsection{字节填充法}
使用控制字符SOH表示帧开始，EOT表示结束。

若帧的数据部分包含特殊字符（控制字符SOH、EOT，转义字符ESC），则发送方在特殊字符前添加转义字符ESC；接收方做逆处理。


\subsubsection{零比特填充法}
使用特殊比特串`01111110`表示帧开始/结束。

发送方对帧数据部分进行处理，每遇到连续的5个1，填充一个0；接收方做逆处理，每遇到连续的5个1，删除一个0.

HDLC协议、PPP协议使用。


\subsubsection{违规编码法}
违规编码基于曼彻斯特编码IEEE，上跳0下跳1，看中间，中必变。

需要物理层配合。

若周期中间不跳变，则违规。


\subsection{差错控制}

\paragraph{目标}
发现并解决一个帧内部的“位错”。


\subsubsection{检错编码}
接收方\textbf{发现比特错}后丢弃帧，通知发送方重传帧。

\paragraph{奇偶校验码}
整个校验码（有效信息位+校验位）中1的个数。
\begin{itemize}
    \item 奇校验码：1的个数为奇数；
    \item 偶校验码：1的个数为偶数；
\end{itemize}
\subparagraph{偶校验硬件实现}
各信息位进行\textbf{异或}运算，结果为偶校验位。将偶校验的信息位、校验位异或，结果为0则没有错误。

仅能检测处奇数位错误，无纠错能力。


\paragraph{CRC码（循环冗余校验）}
发送接收方约定一个“除数”，K信息位、R校验位作为“被除数”，添加校验位后保证除法余数为0。

\subparagraph{构造}
设生成多项式\(G(x)\)，R位数为\(G(x)\)最高次幂，二进制码为多项式系数。信息位左移R位，对二进制码进行模2除法，得到余数即除数，除数有R + 1位。

\subparagraph{纠错}
\begin{itemize}
    \item 可检测所有奇数个错误
    \item 可检测所有双比特错误
    \item 可检测所有小于等于校验位长度的连续错误
    \item 若选择合适多项式，且\(2^R >= K + R + 1\)，则可纠正单比特错
\end{itemize}


\subsubsection{纠错编码}

\paragraph{海明校验码}
信息位分组进行偶校验->多个校验位->标注出错位置
\subparagraph{位数}
n位信息位，k位校验位，则\(2^k >= n + k + 1\)。校验位\(P_i\)放到海明位\(2^{i - 1}\)上，信息位按顺序放到其余位置。
\subparagraph{海明位}
\(H_{n + k} ...H_2 H_1\)
\subparagraph{校验位}
\(P_k...P_2P_1\)。以7位海明码为例，\(P_1 = H_3 \oplus H_5 \oplus H_7 = D_1 \oplus D_2 \oplus D_4\)（3低位1，5低位1，6低位0，7低位1）
\subparagraph{格式转换}
海明位\(H_1H_2...H_{n + k}\)，校验位\(P_1P_2...P_1\)
\subparagraph{纠错}
\(S_1 = P_1 \oplus D_1 \oplus D_2 \oplus D_4\)，0则无错
\subparagraph{纠错能力}
1位
\subparagraph{检错能力}
2位
\subparagraph{全校验位}
\(P_{\text{全}} = S_k...S_1\)\begin{itemize}
    \item 为0且偶校验成功\(\Rightarrow\)无错
    \item 不为0且偶校验失败\(\Rightarrow\)1位错，纠正即可
    \item 不为0且偶校验成功\(\Rightarrow\)2位错，需重传
\end{itemize}


\subsection{可靠传输}



\subsection{流量控制}


\subsection{滑动窗口机制}
可靠传输与流量控制基于滑动窗口机制实现。

接收方通过确认机制控制发送方窗口滑动


\subsection{停止等待协议S-W}
不属于滑动窗口协议。
\begin{itemize}
    \item 滑动窗口：发送窗口\(W_T = 1\)，接收窗口\(W_R = 1\)
    \item 确认机制：确认帧ACK\_i，接收方收到i号帧，没有检出错，返回确认帧ACK\_i
    \item 重传机制：超时重传
    \item 帧编号：仅需1bit给帧编号，需要\(W_T + W_R <= 2^n\)；用于区别重复帧
\end{itemize}

\subsubsection{异常情况}
\begin{itemize}
    \item 数据帧丢失：超时重传，重置计时器，计时器超时前收到确认帧
    \item 确认帧丢失：超时重传，接收方收到重复帧，丢弃帧并返回重复帧的ACK
    \item 数据帧出错：丢弃帧，等发送方超时重传
\end{itemize}


\subsection{后退N帧协议GBN}
\begin{itemize}
    \item 滑动窗口：发送窗口\(W_T > 1\)，接收窗口\(W_R = 1\)
    \item 确认机制：确认帧ACK\_i，接收方收到i号帧，没有检出错，返回确认帧ACK\_i；连续收到多个数据帧，仅传最后一个ACK\_i
    \item 重传机制：超时重传；若未收到ACK\_i，重传i及之后所有帧
    \item 帧编号：至少需nbit给帧编号，需要\(W_T + W_R <= 2^n\)；
\end{itemize}

\subsubsection{异常情况}
\begin{itemize}
    \item 数据帧丢失：
    \item 确认帧丢失：
    \item 数据帧出错：
\end{itemize}


\subsection{选择重传协议SR}
\begin{itemize}
    \item 滑动窗口：发送窗口\(W_T > 1\)，接收窗口\(W_R > 1\)
    \item 确认机制：\begin{itemize}
        \item 确认帧ACK\_i，接收方收到i号帧，没有检出错，返回确认帧ACK\_i；不支持累计确认
        \item 否认帧：NAK\_i，接收方收到i帧，但出错，丢弃帧并返回NAK\_i
    \end{itemize}
    \item 重传机制：\begin{itemize}
        \item 超时重传；
        \item 请求重传，发送方收到NAK\_i，则重传i
    \end{itemize}
    \item 帧编号：至少需nbit给帧编号，需要\(W_T + W_R <= 2^n\)且\(W_R <= W_T\)；
\end{itemize}

\subsubsection{异常情况}
\begin{itemize}
    \item 数据帧丢失：
    \item 确认帧丢失：
    \item 数据帧出错：
\end{itemize}


\subsection{三种协议}
\begin{itemize}
    \item 滑动窗口协议：S-W不属于滑动窗口协议；GBN、SR属于滑动窗口协议。
    \item ARQ协议（自动重传请求协议）：包括S-W、GBN、SR。\begin{itemize}
        \item 连续ARQ协议：只包括GBN、SR。
    \end{itemize}
\end{itemize}

\subsubsection{信道利用率}
\(T_D\)数据传输时延，\(RTT\)两倍的单向传输时延，\(T_A\)确认帧传输时延，发送窗口大小\(N\)。
\begin{itemize}
    \item S-W：理想情况下\footnote{没有帧丢失、比特错误等异常情况}\(U = \dfrac{T_D}{T_D + RTT + T_A}\)，若\(T_A\)极短，则通常可忽略不计。
    \item GBN、SR：\(U = \dfrac{NT_D}{T_D + RTT + T_A}\)；当\(NT_D >= T_D + RTT + T_A\)，则U为1（不能大于1）；常结合考察帧编号\footnote{\(W_T + W_R <= 2^n\)}。
    \begin{itemize}
        \item 相同nbit给帧编号，GBN\(W_R\)更小，\(W_T\)更大，故信道利用率也更大。
    \end{itemize}
\end{itemize}


\section{介质访问控制MAC}

\subsection{信道划分}

\subsubsection{时分复用TDM}
时间分为等长TDM帧，每个帧分为等长m个时隙，将m个时隙分给m对用户（节点）使用。

缺点：每个节点最多分配到信道总带宽的\(\dfrac{1}{m}\)；若某节点暂不发送数据，时隙闲置，信道利用率低。


\subsubsection{统计时分复用STDM}
又称\textbf{异步时分复用}。在TDM基础上，动态分配时隙。

优点：


\subsubsection{频分复用FDM}
将信道总频带划分为多个子频带，每个子频带作为一个子信道，每对用户使用一个子信道。


\subsubsection{波分复用WDM}
即\textbf{光的频分复用}。


\subsubsection{码分复用CDM}
是CDMA的底层原理。

\begin{itemize}
    \item 给各节点分配专属“码片序列”：\begin{itemize}
        \item 码片序列包含m个码片，可看作m维向量；
        \item 各节点m维向量相互正交；
        \item 相互通信的节点知道彼此码片序列；
    \end{itemize}
    \item 发送方发送数据：\begin{itemize}
        \item 发出m个信号值与码片序列相同，表示比特1；
        \item 发出m个信号值与码片序列相反，表示比特0；
    \end{itemize}
    \item 信号在传输过程中叠加：\begin{itemize}
        \item 本质m维向量的加法；
    \end{itemize}
    \item 接收方接收数据：收到叠加信号，从中分离各发送方数据，与发送方码片序列作规格化内积\begin{itemize}
        \item 结果为1，表示比特1；
        \item 结果为-1，表示比特0；
    \end{itemize}
\end{itemize}


\subsection{随机访问}

\subsubsection{ALOHA协议}
\begin{itemize}
    \item 纯ALOHA：准备好数据帧就立即发送；
    \item 时隙ALOHA：时隙大小固定=传送一个最长帧所需时间；仅在时隙开始时才发送帧；\begin{itemize}
        \item 发生冲突时，发生冲突的各节点随机推迟若干时隙；
        \item 避免用户发送数据的随机性，降低冲突概率，提高利用率；
    \end{itemize}
\end{itemize}


\subsubsection{CSMA协议}
载波监听多路访问协议。发送数据前，先监听信道是否空闲，若空闲，则尝试发送。
\begin{itemize}
    \item 1-坚持CSMA协议：坚持表示若信道不空闲则坚持监听\begin{itemize}
        \item 优点：信道利用率高，一旦空闲就被下一信道使用；
        \item 缺点：多个节点准备好时，一旦空闲，多个节点同时发送，冲突概率高；
    \end{itemize}
    \item 非坚持CSMA协议：\begin{itemize}
        \item 优点：多个节点准备好时，若不空闲，则随机推迟一段时间再尝试监听；
        \item 刚空闲时可能不会立即被利用，信道利用率低；
    \end{itemize}
    \item p-坚持CSMA协议：\begin{itemize}
        \item 属于坚持与非坚持的折中，降低冲突的同时提高利用率；
    \end{itemize}
\end{itemize}


\subsubsection{CSMA/CD协议}
CD表示冲突检测。用于早期以太网（总线型）。

\begin{itemize}
    \item 先听后发，边听边发，冲突停发，随机重发；
    \item 随机重发：截断二进制指数退避算法：随机等待一段时间=r倍\textbf{争用期}\footnote{是一段固定大小的时间，=2*最远单向传播时延}，r是随机数\begin{itemize}
        \item 若\(k <= 10\)，在\([0, 2^k - 1]\)内随机取一个整数r；
        \item 若\(k > 10\)，在\([0, 2^{10} - 1]\)内随机取一个整数r；
    \end{itemize}
    \item \begin{itemize}
        \item 第10次冲突，是随机重发的分水岭；
        \item 第16次冲突，放弃传帧，报告上级（网络层）
    \end{itemize}
\end{itemize}

若争用期内未发生冲突，则不可能再冲突。

CSMA/CD没有ACK机制，若未检测到冲突，则认为帧发送成功。

\paragraph{最短帧长}
= 2 * 最远单向传播时延 * 信道带宽。

若收到帧小于最短帧长，则视为无效帧。

\paragraph{最长帧长}
防止某些节点一直占用信道。

\paragraph{以太网规定}
\begin{itemize}
    \item 最短帧长64B
    \item 最长帧长1518B
\end{itemize}


\subsubsection{CSMA/CA协议}
CA表示冲突避免。用于IEEE 802.11无线局域网（WiFi）

\begin{itemize}
    \item 发送方：先听后发：忙则退避：\begin{itemize}
        \item 
        \item 
    \end{itemize}
    \item 随机退避原则：
    \item 接收方：停止等待协议：每收到一个正确数据帧发送一个ACK；
\end{itemize}

\paragraph{信道预约机制（可选功能）}
\begin{itemize}
    \item 发送方广播RTS控制帧\footnote{请求发送，包括：源地址、目的地址、通信所需持续时间}（需指明预约时长）
    \item AP（接入点，包括WiFi热点）\footnote{家庭路由器 = 路由器 + 交换机 + AP；}广播CTS控制帧\footnote{允许发送，包括：源地址、目的地址、通信所需持续时间}（需指明预约时长）
    \item 其他无关节点收到CTS后自动禁言一段时间（虚拟载波监听机制），发送方收到CTS后可以发送数据帧；
    \item AP收到数据帧后，进行CRC校验，若无差错则返回ACK帧；
\end{itemize}

\paragraph{帧间间隔IFS}
\begin{itemize}
    \item DIFS：最长IFS，每次帧事务开始时需要等待的时间
    \item SIFS：最短IFS，收到一个帧后需要预留的一段处理时间
    \item PIFS：中等长度IFS，考研可不关注
\end{itemize}


\paragraph{为什么不CSMA/CD？}
\begin{enumerate}
    \item 硬件难以实现边听边发、冲突检测；
    \item 存在隐蔽站问题；
\end{enumerate}


\subsection{令牌传递协议（轮询访问）}
\begin{itemize}
    \item 每次只传一个帧，传完即释放令牌（即生成一个新令牌）。
    \item 无论令牌帧、数据帧只能单向传输。
    \item 需要专门的MAU\footnote{多站接入单元，用于集中控制令牌环网。}实现集中控制；
    \item 适用于负载高的网络（不会冲突）
\end{itemize}


\subsubsection{令牌帧}
帧定界（开始）|令牌号|帧定界（结束）

指明当前获得令牌的节点，只有获得令牌的节点才能发送数据帧；

若获得令牌的节点没有数据要发送，则将令牌传给下一节点；


\subsubsection{数据帧}
帧定界（开始）|令牌号|目的地址|源地址|数据部分|CRC校验码|帧定界（结束）|是否接收

指明数据帧的源地址、目的地址、获得令牌的节点编号、是否已被接收；

从源节点出发，传递一圈后回到源节点；

传递一圈时，目的节点会复制一份数据，并将数据帧标记为已接收；

回到源节点后，若有异常情况，则重发；若无，则将令牌传给下一节点；


\section{局域网}

\subsection{IEEE802与以太网}

\subsubsection{职责}

\subsubsection{层次划分}
数据链路层分为：\begin{itemize}
    \item 逻辑链路控制(LLC)子层：为了兼容各种局域网技术，名存实亡。有线局域网被802.3垄断；无线局域网被802.11垄断
    \item 介质访问控制(MAC)子层：与传输介质有关的部分功能（如组帧、差错检测等）。物理层均使用曼彻斯特编码，物理层在MAC帧前添加前导码8B（7B前同步码，1B定界符）
    \begin{itemize}
        \item DIX...V2标准（市面上常用）
        \item IEEE802.3标准
    \end{itemize}
\end{itemize}


\subsubsection{V2标准MAC帧}
目的地址（6B，48bit）|源地址（6B，48bit）|类型（2B，指明网络层协议）|数据（46~1500，存放IP数据报，短则填充、长则分片，限制最短最长帧长）|FCS（CRC校验码）


\subsubsection{IEEE802.3标准MAC帧}


\subsection{802.11无线局域网}

\subsubsection{分类}
\begin{itemize}
    \item 有固定基础设施：802.11
    \item 无固定基础设施
\end{itemize}


\subsubsection{概念}

\begin{itemize}
    \item 802.11无线局域网是星形拓扑，中心是接入点AP，又称无线接入点WAP。使用\textbf{CSMA/CA协议}实现介质访问控制。
    \item 门户（Portal）：将802.11无线局域网接入802.3有限以太网
    \item 基本服务集BSS：一个基站（AP）+多个服务站
    \item 服务集标识符SSID：无线局域网名字，不超过32字节
    \item 基本服务区BSA：一个BSS能覆盖的地理范围
    \item 扩展服务集ESS：将多个AP接入同一分配系统，组成更大服务集
    \item 漫游：一个移动站从一个BSS移动到另一BSS仍可保持通信
\end{itemize}
两个移动站不能直接通信，必须有AP转发。

AP通常可进行帧格式转换，可将在无线链路上传输的802.11帧格式，与在有线链路上传输的以太网帧格式相互转换。
\begin{itemize}
    \item AP与移动点之间无线链路传输
    \item AP之间、AP与路由之间、AP与以太网交换机之间通常有线链路
\end{itemize}


\subsubsection{802.11帧分类}
\begin{enumerate}
    \item 数据帧
    \item 控制帧：ACK、RTS、CTS
    \item 管理帧：探测请求/响应帧
\end{enumerate}


\subsubsection{802.11数据帧格式}



\subsubsection{传输介质适用情况}
\begin{itemize}
    \item 同轴电缆仅半双工
    \item 双绞线：\begin{itemize}
        \item 速率<2.5Gbps，可半双工或全双工
        \item 速率>2.5Gbps，仅全双工
    \end{itemize}
    \item 光纤仅全双工
    \item 默认交换机连接的终端节点都可以全双工
\end{itemize}
不同网段可采用不同标准。


\subsection{三要素}
\begin{enumerate}
    \item 拓扑结构
    \item 传输介质
    \item 介质访问控制方式
\end{enumerate}


\subsection{特点}


\subsection{硬件架构}


\subsection{VLAN}
虚拟局域网。802.1Q
\begin{itemize}
    \item 将一个大型局域网分为多个小型VLAN，\textbf{每个VLAN是一个广播域}。
    \item 需要使用支持VLAN功能的以太网交换机实现。
    \item 每个VLAN对应一个VID
\end{itemize}

\subsubsection{划分方式}
\begin{enumerate}
    \item 基于接口
    \item 基于MAC地址
    \item 基于IP地址，可让VLAN范围跨越路由器，让多个局域网主机组成一个VLAN（需网络层支持）
\end{enumerate}


\subsubsection{802.1Q帧的作用}
主机与交换机之间，传输标准以太网帧；交换机与交换机之间，传输802.1Q帧


\subsubsection{802.1Q帧的结构}
在标准以太网帧的源地址之后插入VLAN标签4B。


\section{广域网}

通信子网使用\textbf{分组交换技术}。

\subsection{点对点协议PPP}
只支持全双工链路。

应满足要求：\begin{itemize}
    \item 
\end{itemize}

无需满足：

三个组成部分：\begin{enumerate}
    \item 一个将IP数据报封装到串行链路的方法；
    \item 链路控制协议LCP；
    \item 网络控制协议NCP；
\end{enumerate}

帧格式：


\subsection{高级数据链路控制HDLC协议}
数据报文可透明传输（0比特插入法）易于硬件实现。

采用全双工通信。

所有帧使用CRC检验，对信息帧进行顺序编号，传输可靠性高。

站：\begin{itemize}
    \item 主站
    \item 从站
    \item 复合站
\end{itemize}

三种数据操作方式：\begin{itemize}
    \item 
\end{itemize}

帧格式


\subsection{比较}
同\begin{itemize}
    \item 都仅全双工
    \item 都透明传输
    \item 都差错检测但不纠错
\end{itemize}

异：
