
\chapter{网络层}

为传输层提供服务，将传输层数据封装成IP数据报。网络中路由器根据IP数据报首部源IP地址、目的IP地址进行分组转发，实现“主机到主机”的传输。

\section{功能}

\subsection{异构网络互联}

\paragraph{异构}
每个网络拓扑结构不同，物理层、链路层实现不同、主机类型不同。


\paragraph{重要设备}
路由器。TCP/IP文献中，路由器又称网关。


\subsection{路由与转发}

\subsubsection{路由}
各路由器之间相互配合，规划IP数据报的最佳转发路径。

各路由器需要允许路由协议，最终生成各自的路由表。


\subsubsection{转发}
一台路由器根据自己的\textbf{转发表}，将IP数据报从合适的接口转发出去。

转发表 = 精简路由表。数据结构更简洁，便于快速检索。


\subsection{拥塞控制}

\subsubsection{拥塞}

\subparagraph{原因}
出现过量分组，超负荷，性能下降。


\subparagraph{现象}
分组数增加，吞吐率下降。


\subsubsection{开环控制（静态）}
部署网络时，提前设计好预防拥塞的方法，一旦开始运行便不再修改。


\subsubsection{闭环控制（动态）}
动态监测网络状态，及时发现拥塞，将拥塞信息传给路由器。相关路由器及时调整路由表。


\section{IP数据报（IP分组）}

\subsection{格式}
\begin{itemize}
    \item 首部（最小20B，最大\(2^4 * 4B = 60B\)\begin{itemize}
        \item 固定部分（20B）：|版本4bit\footnote{区分网络层使用的IP协议版本（v4、v6）}|首部长度4bit\footnote{0\(\sim\)15，以*4B为单位}|区分服务8bit\footnote{一般用不到}|总长度16bit\footnote{0\(\sim\)65535，以*1B为单位，涵盖首部和数据部分}|
        
        |标识16bit\footnote{由IP数据报源主机生成，一般为自增序列}|标志3bit\footnote{最低位MF，MF=1，后面还有分片；MF=0，后面没有分片。次低位DF，DF=1，不允许被切片；DF=0，允许被切片}|片偏移13bit\footnote{数据部分在被分片前的位置，以*8B为单位}|
        
        |生存时间8bit\footnote{数据报在网络中可通过的路由器数的最大值TTL。初值由源主机设置，每经过一个路由器TTL-=1；若减到0，则丢弃，并向源主机发送ICMP报文}|协议8bit\footnote{若为TCP，则设为6；若为UDP，则设为17}|首部检验和16bit\footnote{每个路由器仅校验首部，若该字段设为全0，表示不用校验；校验和计算方法与UDP相同}|
        
        |源地址32bit发送方IP地址|
        
        |目的地址32bit接收方IP地址|
        
        \item 可变部分（0\(\sim\)40B）：可选字段（长度可变）|填充（凑足4B的整数倍）
    \end{itemize}
    \item 数据部分：最小0B，理论最长=65535-20=65515B
\end{itemize}


\subsection{分片问题}
一个数据链路层帧能承载的最大数据量称为\textbf{最大传送单元MTU}。若一个IP数据报的总长度超出了下一段链路的MTU，则需要分片。

每个分片都可被独立转发，即都包含首部。
\begin{itemize}
    \item 分片可能在\textbf{源主机或任一路由器}中发生
    \item 只有目的主机会对分片进行重组
    \item 各分片可能乱序到达
    \item 由于首部的片偏移字段以*8B为单位，故除最后一个分片外，其余分片数据部分为8B的整数倍
\end{itemize}


\section{IPv4}

\subsubsection{各协议之间关系}

IP协议是互联网的核心。

ARP协议用于查询同一网络中，<IP, MAC>之间的映射关系。

ICMP协议用于网络层各实体之间相互通知异常事件。

IGMP协议用于实现IP组播。


\subsection{IP分类方案}
\begin{itemize}
    \item 单播地址\begin{itemize}
        \item A类（1-126）：|0|网络号1-7|主机号8-31|
        \item B类（128-191）：|1|0|网络号2-15|主机号16-31|
        \item C类（192-223）：|1|1|0|网络号3-23|主机号24-31|
    \end{itemize}
    \item 多播地址：D类（224-239）：|1|1|1|0|多播地址|
    \item 保留使用：E类（240-255）：|1|1|1|1|保留使用|
\end{itemize}
若一个网络中，主机号占nbit，则该网络中最多支持\(2^n - 2\)台主机或路由器。

\subsubsection{特殊IP地址}
\begin{center}
    \begin{tabular}{c|c}
        \hline
        网络号 & 主机号 \\
        \hline
        Y & 全0 \\ 
        \hline
        Y & 全1 \\ 
        \hline
        0 & Y \\ 
        \hline
        全0 & 全0 \\
        \hline
        全1 & 全1 \\ 
        \hline
        127 & 非全0且非全1 \\ 
        \hline
    \end{tabular}
\end{center}


\subsection{子网划分}
设某IP地址段，主机号占n bit，可将前k bit作为子网号，剩下n-k bit作为主机号，则可划分出\(2^k\)个子网。每个子网包含IP地址块大小相同。

\begin{itemize}
    \item 划分前：IP地址两级结构<网络号，主机号>
    \item 划分后：IP地址三级结构<网络号，子网号，主机号>
\end{itemize}

每个子网地址中，主机号不能全0或全1.


\subsection{子网掩码}
子网掩码、IP地址逐位与得到<网络号，子网号>（合称为\textbf{网络前缀}）。只有网络前缀相同的IP地址，才能归属同一网络（子网）。

若一个网络内部进行子网划分，则网络中每台主机、路由器接口都需要配置IP地址、默认网关、子网掩码。

若一台路由器支持子网划分技术，则转发表中，应包含<目的网络号，子网掩码，转发接口>


\subsection{默认子网掩码}
若一个传统网络（A/B/C类）内没有进行子网划分，则将对应此网络的\textbf{转发表项}设为默认子网掩码。


\subsection{默认路由}
默认路由（默认转发表项）设置：<目的网络号全0，子网掩码全0>

在路由转发表中，若所有表项都不匹配，则转发默认路由。


\subsection{主机发送IP数据报的过程}
\begin{enumerate}
    \item 判断目的主机和本机是否处于同一网络\begin{enumerate}
        \item 检测本机IP地址和目的IP地址网络前缀是否相同。相同则同一网络；否则非同一网络。
    \end{enumerate}
    \item 将IP数据报封装成MAC帧并发送到链路上\begin{itemize}
        \item 若属于同一网络，则通过ARP协议找到目的主机的MAC地址，将IP数据报封装成帧，将帧发给\textbf{目的主机}。
        \item 若不属于同一网络，通过ARP协议找到默认网关的MAC地址，将IP数据报封装成帧，将帧发给\textbf{默认网关}。
    \end{itemize}
\end{enumerate}


\subsection{路由器转发IP数据报的过程}
\begin{enumerate}
    \item 路由器某个接口收到一个IP数据报
    \item 对数据报首部进行校验，从中找到\textbf{目的IP地址}
    \item 查转发表\begin{itemize}
        \item 转发表表项包含<目的网络号，子网掩码，转发接口>
        \item 检查目的IP地址与每个表项是否能匹配（目的IP地址、子网掩码逐位与，匹配表项中的目的网络号）
        \item 至少默认路由可以匹配成功
    \end{itemize}
    \item 转发\begin{itemize}
        \item 根据3的结果，将IP数据报从匹配的接口中转发出去
        \item 若匹配的转发接口与入口相同，则不再发送
    \end{itemize}
\end{enumerate}


\subsection{CIDR无分类编址}

\paragraph{原因}
传统IP分类方式资源分配不灵活，利用率低，有限资源很快耗尽。

32bit IP地址：网络前缀（可变长）|主机号


\subsubsection{IP地址结构}
IP地址=<网络前缀，主机号>，其中网络前缀不定长。

记法：xxx.xxx.xxx.xxx/k，网络前缀k bit，主机号32-k bit



\subsubsection{定长子网划分}
CIDR地址块中，主机号前kbit作为定长子网号，可划分\(2^k\)个子网。
每个子网可分配的最大IP地址个数为\(2^{16 - k} - 2\)（全0全1不可私用）


\subsubsection{变长子网划分}
CIDR地址块中，子网号长度不固定，每个子网含IP地址块大小不同。

类似于从根构造哈夫曼树。\begin{itemize}
    \item 原始CIDR地址快为根
    \item 每个分支节点必须同时拥有左右孩子，左0右1或相反
    \item 每个叶子节点对应一个子网，根据\textbf{从根节点到叶节点的路径}分析子网对应\textbf{IP地址范围}
    \item 整棵树高度不超过h-1，最小子网也保留2bit主机号
\end{itemize}


\subsection{路由聚合}
又称\textbf{构成超网}。对一个路由转发表，若几条路由表项转发接口相同，部分网络前缀相同，则可将这几条路由表项聚合为一条。

可减少路由表大小。

可能引入额外的无效地址。

\subsubsection{最长路由匹配原则}
一个IP地址在转发表中可能匹配多个表项，应用最长路由匹配原则。


\subsection{DHCP动态主机配置协议}
是\textbf{应用层协议}，基于UDP：客户端UDP端口号68，服务器端UDP端口号67

\subsubsection{作用}
给刚接入网络的主机动态分配IP地址，配置默认网关、子网掩码。


\subsubsection{使用C/S客户端服务器模型}
\begin{itemize}
    \item 客户：新接入网络的主机
    \item 服务器：负责分配IP地址的主机，管理一系列IP地址池\begin{itemize}
        \item 家庭网络中，通常由家庭路由器兼容DHCP服务器
        \item 在一个大型网络中，可存在多个DHCP服务器
    \end{itemize}
\end{itemize}


\subsubsection{过程}
\begin{enumerate}
    \item 客户 -> 服务器：DHCP发现报文
    \item 服务器 -> 客户：DHCP提供报文
    \item 客户 -> 服务器：DHCP请求报文
    \item 服务器 -> 客户：DHCP确认报文
\end{enumerate}


\subsection{NAT网络地址转换}

\subsubsection{私有IP地址（内网IP）}
\[\begin{cases}
    10.0.0.0 \sim 10.255.255.255 \\
    172.16.0.0 \sim 172.31.255.255 \\
    192.168.0.0 \sim 192.168.255.255
\end{cases}\]
\begin{itemize}
    \item 只能分配给局域网内部节点
    \item 可复用，只要求局域网内唯一
    \item 局域网内部可自由分配
\end{itemize}


\subsubsection{全球IP地址（外网IP）}
通常由ISP提供，全球唯一。

是局域网与外界通信时使用的IP地址


\subsubsection{NAT路由器}

\paragraph{作用}
转发IP数据报时，进行内网IP、外网IP的相互转换。

\paragraph{NAT表}
记录地址转换关系<内网IP:端口号\(\leftrightarrow\)外网IP:端口号>

包含传输层功能（端口号是传输层概念）

一个IP数据报\(\begin{cases}
    \text{从内网到外网，会更改源IP地址、源端口号} \\ 
    \text{从外网到内网，会更改目的IP地址、目的端口号}
\end{cases}\)


\subsection{ARP地址解析协议}

\paragraph{作用}
查询同一网络中<IP地址，MAC地址>之间映射关系。


\paragraph{ARP表（ARP缓存）}
\begin{itemize}
    \item 记录<IP地址，MAC地址>
    \item 需定期更新ARP表项
    \item 每台主机、路由器有自己的ARP表
\end{itemize}

\subsubsection{过程}

\begin{enumerate}
    \item ARP请求分组\begin{itemize}
        \item 内容：谁？（IP地址X，MAC地址Y）找谁？（目的IP地址Z）
        \item ARP请求分组封装进\textbf{MAC帧}（帧目的地址全1，源地址Y）-\textbf{广播帧}
    \end{itemize}
    \item ARP响应分组\begin{itemize}
        \item 内容：IP地址Z，MAC地址V
        \item ARP响应分组封装进MAC帧（帧目的地址Y，源地址V）-\textbf{单播帧}
    \end{itemize}
\end{enumerate}


\section{ICMP网际控制报文协议}
属于网络层，ICMP报文封装在IP数据报中。

让主机或路由器相互报告网络中差错和异常情况。

\subsection{差错报告报文}
\begin{itemize}
    \item 终点不可达\(\begin{cases}
        \text{路由器->发送方：目的IP地址不可达} \\ 
        \text{目的主机->发送方：目的端口号不存在，没有对应进程}
    \end{cases}\)
    \item 时间超过\(\begin{cases}
        \text{路由器->发送方：IP数据报到这里TTL=0} \\ 
        \text{目的主机->发送方：IP数据报被切片，规定时间内未到齐，已全部丢弃}
    \end{cases}\)
    \item 参数问题-->发送方：IP数据报首部参数不合法，或首部校验出错
    \item 改变路由（重定向）-路由器->发送方：对这个网络，下次使用另一路由器，路径更短
\end{itemize}


\subsection{询问报文}
\begin{itemize}
    \item 回送请求
    \item 回送回答
    \item 时间戳请求
    \item 时间戳回答
\end{itemize}


\subsection{不必反馈差错报告报文的情况}
\begin{itemize}
    \item 若携带ICMP差错报告报文的IP数据报出错，不再反馈
    \item 若IP数据报被分片，无论多少分片出错，只反馈一次
    \item 若IP数据报目的地址为多播，不反馈
    \item 若源地址特殊地址，不反馈
\end{itemize}


\subsection{典型应用}
\begin{itemize}
    \item ping：基于\textbf{回送请求报文、回送回答报文}实现功能
    \item tracert：基于\textbf{时间超过报文}实现
\end{itemize}


\section{IPv6地址}
128位。

\subsection{冒号十六进制记法}
共128位，每16位为一段，记录为16进制，段间冒号分隔


\subsection{压缩记法}
\begin{enumerate}
    \item 取出每段前导0
    \item 双冒号::替代连续出现的多个0，一个地址只能出现一次双冒号
\end{enumerate}


\subsection{资源分配}
\begin{itemize}
    \item 支持CIDR
    \item 支持即插即用（IP自动配置）
    \item 可以不使用DHCP，也支持使用DHCP统一管理
\end{itemize}


\subsection{分类}
\begin{center}
    \begin{tabular}{c|c}
        \hline
        地址类型 & 二进制前缀 \\
        \hline
        未指明 & 0...0（128位），记为::/128 \\ 
        \hline
        环回 & 0...01（128位），记为::1/128 \\
        \hline
        多播 & 11111111（8位），记为FF00::/8 \\
        \hline
        本地链路单播 & 1111111010（10位），记为FE80::/10 \\
        \hline
        全球单播 & 以上4种以外 \\
        \hline
    \end{tabular}
\end{center}

3中目的地址\begin{enumerate}
    \item 单播
    \item 多播：数据报发送到一组计算机的每一台
    \item 任播：终点是一组计算机，但数据报只交付其中一台计算机，通常是距离最近的计算机。没有固定前缀
\end{enumerate}























































































