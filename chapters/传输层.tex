
\chapter{传输层}

\section{端口}

\subsection{作用}

\begin{itemize}
    \item 通过\textbf{端口号}标识本机的一个进程\begin{itemize}
        \item 每台主机的端口号相互独立
        \item TCP、UDP端口号相互独立
    \end{itemize}
    \item TCP或UDP通过\textbf{Socket套接字=\{IP地址：端口号\}}唯一地标识网络上一台主机地一个应用进程
\end{itemize}


\subsection{分类}
\begin{itemize}
    \item 服务端使用\begin{itemize}
        \item 熟知端口号\(0\sim 1023\)，通常只能用于被熟知的重要应用程序
        \item 登记端口号\(1024 \sim 49151\)
    \end{itemize}
    \item 客户端使用：短暂端口号\(49152 \sim 65535\)
\end{itemize}


\section{功能}
\begin{itemize}
    \item 实现端到端（进程到进程）的通信
    \item 复用和分用\begin{itemize}
        \item 复用（从上到下）：发送数据时，同一主机上多个进程可以使用同一个传输层协议
        \item 分用（从下到上）：传输层可以把数据正确交付到目的进程
    \end{itemize}
    \item 差错检测\begin{itemize}
        \item TCP：丢弃数据，通知发送方重传
        \item UDP：丢弃数据，不通知发送方
    \end{itemize}
    \item 向应用层提供服务：\begin{itemize}
        \item \textbf{面向连接的、可靠的}端到端传输服务TCP
        \item \textbf{无连接的、不可靠的}端到端传输服务UDP
    \end{itemize}
\end{itemize}

\subsection{连接}
\begin{itemize}
    \item 有连接：确认对方准备好接收数据
    \item 无连接：
\end{itemize}

\subsection{可靠}
\begin{itemize}
    \item 可靠：接收方使用确认机制，让发送方知道哪些数据被接收
    \item 不可靠：
\end{itemize}


\section{UDP}

\subsection{数据报}
\begin{itemize}
    \item 首部小，仅8B
    \item 每次传输一个完整报文，\textbf{不支持自动拆分重装}，因此应用层报文长度不能超过UDP上限
    \item 不支持拥塞控制
    \item 不可靠，可靠性靠应用层控制
    \item 支持一对一、一对多
\end{itemize}

\subsubsection{格式}
首部8B：|16位源端口号|16位目的端口号|16位UDP长度|16位UDP校验和|

理论最大长度65535B。


\subsection{校验}
32bit数据+16bit校验和

数据以16bit为一组做加法（最高位进位\textbf{回卷}）后取反得到\textbf{校验和}。

以16bit为一组做加法（最高位进位\textbf{回卷}），若无比特错误，则结果一定全1.

计算校验和之前添加伪首部；计算完成后去掉伪首部。

\paragraph{伪首部格式}
|源IP地址4B|目的IP地址4B|0（1B）|17（1B）|UDP长度2B|

\subsubsection{发送方}
\begin{enumerate}
    \item 计算校验和之前添加伪首部；
    \item 把伪首部、首部、数据部分以16bit为一组做加法（最高位进位\textbf{回卷}）
    \item 加法结果按位取反，得到16bit校验位，填入UDP首部；
    \item 去掉伪首部，将UDP数据报交给网络层，封装为IP数据报。
\end{enumerate}

\subsubsection{接收方}
\begin{enumerate}
    \item 网络层向传输层递交UDP数据报
    \item 添加伪首部
    \item 把伪首部、首部、数据部分以16bit为一组做加法（最高位进位\textbf{回卷}）
    \item 若全1，则无错，接收数据报，根据目的端口号向应用层提交报文；若不全1，则有错，丢弃数据报。
\end{enumerate}


\section{TCP}

\subsection{数据报}
\begin{itemize}
    \item 首部大，\(20\sim60\)B
    \item 支持报文自动拆分重装，可以传输长报文
    \item 支持拥塞控制
    \item 仅支持一对一
\end{itemize}

\subsubsection{格式}
首部\begin{itemize}
    \item 固定首部20B\begin{itemize}
        \item 源端口
        \item 目的端口
        \item 序号seq
        \item 确认号ack/ack\_seq
        \item 数据偏移4bit，TCP首部长度，以*4B为单位
        \item 保留
        \item \begin{itemize}
            \item URG
            \item ACK(1bit)\begin{itemize}
                \item =0时，ack\_seq无效
                \item =1时，ack\_seq有效
            \end{itemize}
            \item PSH
            \item RST
            \item SYN
            \item FIN
        \end{itemize}
        \item 窗口
        \item 校验和
        \item 紧急指针
    \end{itemize}
    \item 选项（长度可变）
    \item 填充，凑4B整数倍
\end{itemize}


\subsection{过程}
\begin{enumerate}
    \item 建立连接（三次握手），对应3个TCP报文段
    \item 双向传输TCP段（全双工通信）
    \item 释放连接（四次挥手）：
\end{enumerate}

每次TCP可传输多个报文；

TCP是面向字节流的，UDP是面向报文的










































































